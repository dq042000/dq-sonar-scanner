## 修改設定

### Step 1. 開啟 /etc/sysctl.conf

請於終端機輸入下方指令

```shell=
sudo vi /etc/sysctl.conf
```

### Step 2. 新增設定

在 /etc/sysctl.conf 檔案最後加入下面兩行設定

```shell=
vm.max_map_count=262144
fs.file-max=65536
```

> vm.max_map_count: 控制一個進程可以擁有的虛擬記憶體映射數量的上限  
> fs.file-max: 允許的文件描述符數目的上限

### Step 3. 設定生效

請於終端機輸入下方指令

```shell=
sudo sysctl -p
```

## 安裝 SonarQube Community 版本

### Step 1. 建立 docker-compose.yml

其檔案內容新增如下

```shell=
version: "3"

services:
  sonarqube:
    image: sonarqube:community
    depends_on:
      - db
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    ports:
      - "9000:9000"
  db:
    image: postgres:12
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

volumes:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql:
  postgresql_data:
```

### Step 2. 安裝 SonarQube

請於終端機輸入下方指令

```shell=
sudo docker-compose up -d
```

## 修改 SonarQube 登入的預設密碼

### Step 1. 透過瀏覽器開啟 SonarQube

網址 http://sonar-qube:9000

### Step 2. 修改預設密碼

使用者登入帳號為 `admin`、預設登入密碼為 `admin`

![](https://hackmd.io/_uploads/S1U75JTW6.png)

## 程式專案設定與掃描

### Step 1. 點選 Manually

![](https://hackmd.io/_uploads/Skwd916ZT.png)


### Step 2. 輸入專案相關資訊

![](https://hackmd.io/_uploads/BkAq9kp-6.png)


### Step 3. 設定 baseline

依需求來選擇，本範例選擇 `Use the global setting`

![](https://hackmd.io/_uploads/HJqpc16-6.png)


### Step 4. 選擇所要分析的 Repository

本範例使用 `GitLab`，故選擇 `With GitLab CI`

![](https://hackmd.io/_uploads/r1M1iJ6Za.png)


### Step 5. 依需求建立 GitHub Secrets

於 GitHub 建立 SONAR_TOKEN 與 SONAR_HOST_URL 的 Secrets

![](https://hackmd.io/_uploads/r1t7jJpbT.png)


### Step 6. 選擇語言

本範例選擇 Other (for JS, TS, Go, Python, PHP, ...)

附上 `.gitlab-ci.yml`

```yml=
stages:
    - sonarqube-check

sonarqube-check:
  stage: sonarqube-check
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  allow_failure: true
  only:
    - develop
```